"use strict";const r=require("electron"),C=require("path"),L=require("child_process"),j=require("fs"),F=require("os"),Q=require("crypto");function R(e){const o=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const n in e)if(n!=="default"){const t=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(o,n,t.get?t:{enumerable:!0,get:()=>e[n]})}}return o.default=e,Object.freeze(o)}const p=R(C),P=R(j);var b={exports:{}};const W="16.5.0",z={version:W},N=j,V=C,G=F,J=Q,H=z,U=H.version,X=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Z(e){const o={};let n=e.toString();n=n.replace(/\r\n?/mg,`
`);let t;for(;(t=X.exec(n))!=null;){const i=t[1];let a=t[2]||"";a=a.trim();const s=a[0];a=a.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),s==='"'&&(a=a.replace(/\\n/g,`
`),a=a.replace(/\\r/g,"\r")),o[i]=a}return o}function ee(e){const o=K(e),n=d.configDotenv({path:o});if(!n.parsed){const s=new Error(`MISSING_DATA: Cannot parse ${o} for an unknown reason`);throw s.code="MISSING_DATA",s}const t=q(e).split(","),i=t.length;let a;for(let s=0;s<i;s++)try{const l=t[s].trim(),u=ne(n,l);a=d.decrypt(u.ciphertext,u.key);break}catch(l){if(s+1>=i)throw l}return d.parse(a)}function oe(e){console.log(`[dotenv@${U}][WARN] ${e}`)}function y(e){console.log(`[dotenv@${U}][DEBUG] ${e}`)}function q(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function ne(e,o){let n;try{n=new URL(o)}catch(l){if(l.code==="ERR_INVALID_URL"){const u=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw u.code="INVALID_DOTENV_KEY",u}throw l}const t=n.password;if(!t){const l=new Error("INVALID_DOTENV_KEY: Missing key part");throw l.code="INVALID_DOTENV_KEY",l}const i=n.searchParams.get("environment");if(!i){const l=new Error("INVALID_DOTENV_KEY: Missing environment part");throw l.code="INVALID_DOTENV_KEY",l}const a=`DOTENV_VAULT_${i.toUpperCase()}`,s=e.parsed[a];if(!s){const l=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${a} in your .env.vault file.`);throw l.code="NOT_FOUND_DOTENV_ENVIRONMENT",l}return{ciphertext:s,key:t}}function K(e){let o=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(const n of e.path)N.existsSync(n)&&(o=n.endsWith(".vault")?n:`${n}.vault`);else o=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else o=V.resolve(process.cwd(),".env.vault");return N.existsSync(o)?o:null}function S(e){return e[0]==="~"?V.join(G.homedir(),e.slice(1)):e}function re(e){!!(e&&e.debug)&&y("Loading env from encrypted .env.vault");const n=d._parseVault(e);let t=process.env;return e&&e.processEnv!=null&&(t=e.processEnv),d.populate(t,n,e),{parsed:n}}function ae(e){const o=V.resolve(process.cwd(),".env");let n="utf8";const t=!!(e&&e.debug);e&&e.encoding?n=e.encoding:t&&y("No encoding is specified. UTF-8 is used by default");let i=[o];if(e&&e.path)if(!Array.isArray(e.path))i=[S(e.path)];else{i=[];for(const u of e.path)i.push(S(u))}let a;const s={};for(const u of i)try{const g=d.parse(N.readFileSync(u,{encoding:n}));d.populate(s,g,e)}catch(g){t&&y(`Failed to load ${u} ${g.message}`),a=g}let l=process.env;return e&&e.processEnv!=null&&(l=e.processEnv),d.populate(l,s,e),a?{parsed:s,error:a}:{parsed:s}}function te(e){if(q(e).length===0)return d.configDotenv(e);const o=K(e);return o?d._configVault(e):(oe(`You set DOTENV_KEY but you are missing a .env.vault file at ${o}. Did you forget to build it?`),d.configDotenv(e))}function ce(e,o){const n=Buffer.from(o.slice(-64),"hex");let t=Buffer.from(e,"base64");const i=t.subarray(0,12),a=t.subarray(-16);t=t.subarray(12,-16);try{const s=J.createDecipheriv("aes-256-gcm",n,i);return s.setAuthTag(a),`${s.update(t)}${s.final()}`}catch(s){const l=s instanceof RangeError,u=s.message==="Invalid key length",g=s.message==="Unsupported state or unable to authenticate data";if(l||u){const h=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw h.code="INVALID_DOTENV_KEY",h}else if(g){const h=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw h.code="DECRYPTION_FAILED",h}else throw s}}function se(e,o,n={}){const t=!!(n&&n.debug),i=!!(n&&n.override);if(typeof o!="object"){const a=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw a.code="OBJECT_REQUIRED",a}for(const a of Object.keys(o))Object.prototype.hasOwnProperty.call(e,a)?(i===!0&&(e[a]=o[a]),t&&y(i===!0?`"${a}" is already defined and WAS overwritten`:`"${a}" is already defined and was NOT overwritten`)):e[a]=o[a]}const d={configDotenv:ae,_configVault:re,_parseVault:ee,config:te,decrypt:ce,parse:Z,populate:se};b.exports.configDotenv=d.configDotenv;b.exports._configVault=d._configVault;b.exports._parseVault=d._parseVault;var ie=b.exports.config=d.config;b.exports.decrypt=d.decrypt;b.exports.parse=d.parse;b.exports.populate=d.populate;b.exports=d;const _=p.join(__dirname,".."),D=process.env.VITE_DEV_SERVER_URL,w=p.join(_,"dist");process.env.VITE_PUBLIC=D?p.join(_,"public"):w;let c=null,m=null;const $=5e3;let E=null,v=!1;r.app.isQuitting=!1;function le(){const e=p.join(_,".."),o=r.app.isPackaged?p.join(r.app.getAppPath(),"packaged-resources",".env"):p.join(e,".env");console.log(`[Main Process] Intentando cargar .env desde: ${o}`),P.existsSync(o)||console.warn(`[Main Process] Advertencia: Archivo .env no encontrado en ${o}`);const n=ie({path:o});return n.error?(console.error("[Main Process] Error cargando el archivo .env:",n.error),r.dialog.showErrorBox("Error de Configuración",`No se pudo cargar el archivo .env desde ${o}. La aplicación podría no funcionar correctamente.`)):Object.keys(n.parsed||{}).length>0?console.log("[Main Process] .env cargado exitosamente."):P.existsSync(o)&&console.warn("[Main Process] .env encontrado pero vacío o con error de parseo no capturado."),n.parsed||{}}function O(){return new Promise((e,o)=>{const n=le(),t=p.join(_,".."),i="SondaClickBackend.exe",a=r.app.isPackaged?p.join(r.app.getAppPath(),"packaged-backend",i):p.join(t,"backend","dist",i);if(console.log(`[Main Process - startBackend] Intentando iniciar backend desde: ${a}`),!P.existsSync(a)){const f=`[Main Process - startBackend] Error: El ejecutable del backend no se encontró en ${a}`;console.error(f),r.app.isPackaged&&r.dialog.showErrorBox("Error Crítico de Backend",`El archivo del backend no se encontró en la ruta esperada: ${a}. La aplicación no puede continuar.`),o(new Error(f));return}const s={...process.env,...n},l=p.dirname(a);m=L.spawn(a,[],{shell:!1,cwd:l,env:s,stdio:"inherit"}),console.log("[Main Process - startBackend] Proceso backend invocado."),m.on("error",f=>{console.error("[Main Process - startBackend] Fallo al iniciar el proceso del backend:",f),r.app.isPackaged&&r.dialog.showErrorBox("Error de Backend","No se pudo iniciar el proceso del backend: "+f.message),m=null,o(f)}),m.on("exit",(f,T)=>{console.log(`[Main Process - startBackend] Proceso del backend terminó con código ${f} y señal ${T}`),f!==0&&r.app.isPackaged&&!r.app.isQuitting&&r.dialog.showErrorBox("Error de Backend",`El proceso del backend terminó inesperadamente. Código: ${f}, Señal: ${T}. Por favor, reinicie la aplicación.`),m=null});let u=0;const g=20,h=1500,Y=3e3,x=()=>{fetch(`http://localhost:${$}/api/check-domain`).then(f=>{if(f.ok)console.log("[Main Process] ¡Backend listo!"),e();else throw new Error(`[Main Process] Backend respondió con ${f.status}`)}).catch(f=>{u++,u<g?(console.log(`[Main Process] Backend no listo, reintentando (${u}/${g}). Error: ${f.message}`),setTimeout(x,h)):(console.error("[Main Process] Backend falló al iniciar después de múltiples reintentos."),o(new Error("Timeout del backend: No se pudo conectar después de varios intentos.")))})};setTimeout(x,Y)})}function B(e,o){if(r.Notification.isSupported()){console.log("[Main Process] showMainProcessNotification: Mostrando notificación - Título:",e);const n="icon.ico",t=process.env.VITE_PUBLIC?p.join(process.env.VITE_PUBLIC,n):p.join(w,n);P.existsSync(t)||console.warn(`[Main Process] Icono de notificación no encontrado en ${t}`);const i=new r.Notification({title:e,body:o,icon:P.existsSync(t)?t:void 0});i.show(),i.on("click",()=>{console.log("[Main Process] Notificación del proceso principal clickeada:",e),c==null||c.show(),c==null||c.focus()}),i.on("close",()=>console.log("[Main Process] Notificación del proceso principal cerrada:",e))}else console.log("[Main Process] Las notificaciones no son compatibles en este sistema.")}function k(){if(!E)return;const e=A.find(n=>n.id==="toggleWindow");e&&(e.label=v?"Mostrar SondaClick":"Ocultar SondaClick");const o=r.Menu.buildFromTemplate(A);E.setContextMenu(o)}const A=[{id:"toggleWindow",label:"Ocultar SondaClick",click:()=>{c&&(v?(c.show(),process.platform==="darwin"?r.app.focus({steal:!0}):c.focus()):c.hide(),v=!v,k())}},{type:"separator"},{id:"quit",label:"Salir de SondaClick",click:()=>{r.app.isQuitting=!0,r.app.quit()}}];function M(){const e="icon.ico",o=process.env.VITE_PUBLIC?p.join(process.env.VITE_PUBLIC,e):p.join(w,e);if(c=new r.BrowserWindow({width:1200,height:800,icon:P.existsSync(o)?o:void 0,webPreferences:{preload:p.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),c.webContents.on("did-finish-load",()=>{c==null||c.webContents.send("main-process-message",new Date().toLocaleString())}),D)c.loadURL(D);else{const n=p.join(w,"index.html");if(!P.existsSync(n)){console.error(`[Main Process] Error: index.html no encontrado en ${n}`),r.dialog.showErrorBox("Error Crítico",`No se pudo cargar la interfaz de la aplicación. Archivo no encontrado: ${n}`),r.app.isQuitting=!0,r.app.quit();return}c.loadFile(n)}c.on("close",n=>{r.app.isQuitting||(n.preventDefault(),c==null||c.hide(),v=!0,k())}),r.app.isPackaged?console.log("[Main Process - createWindow] Aplicación empaquetada. Abriendo DevTools para depuración."):console.log("[Main Process - createWindow] Aplicación en desarrollo. Abriendo DevTools.")}function I(){const e="icon.ico",o=process.env.VITE_PUBLIC?p.join(process.env.VITE_PUBLIC,e):p.join(w,e);if(console.log(`[Main Process] Intentando cargar icono para Tray desde: ${o}`),!P.existsSync(o)){console.error(`[Main Process] Error: La imagen del icono para la bandeja no se encontró en ${o}. No se creará la bandeja.`);return}let n;try{if(n=r.nativeImage.createFromPath(o),n.isEmpty()){console.error(`[Main Process] Error: La imagen del icono en ${o} está vacía o no se pudo cargar.`);return}}catch(t){console.error(`[Main Process] Error al crear nativeImage desde ${o}:`,t);return}E=new r.Tray(n),E.setToolTip("SondaClick Agente"),k(),E.on("click",()=>{c&&(v?(c.show(),process.platform==="darwin"?r.app.focus({steal:!0}):c.focus()):c.hide(),v=!v,k())})}const de=r.app.requestSingleInstanceLock();de?(r.app.on("second-instance",()=>{console.log("[Main Process] Se intentó abrir una segunda instancia."),c&&(c.isMinimized()&&c.restore(),c.isVisible()||c.show(),c.focus(),v=!1,k())}),process.platform==="win32"&&r.app.setAppUserModelId("SondaClick.Mexico"),r.app.whenReady().then(async()=>{console.log("[Main Process] app.whenReady: Iniciando (instancia única)...");try{await O(),console.log("[Main Process] Backend iniciado. Creando ventana y Tray..."),M(),I(),setTimeout(()=>{B("¡Bienvenido a SondaClick!","La aplicación se ha iniciado correctamente.")},1e3)}catch(e){console.error("[Main Process] Error crítico durante el inicio:",e);const o=e instanceof Error?e.message:String(e);r.dialog.showErrorBox("Error Crítico de Inicio",`No se pudo iniciar la aplicación correctamente. La aplicación se cerrará.

Detalles: ${o}`),r.app.isQuitting=!0,r.app.quit()}}),r.ipcMain.on("show-native-notification",(e,{title:o,body:n})=>{console.log("[Main Process] Recibida solicitud IPC 'show-native-notification'"),B(o,n)}),r.app.on("before-quit",e=>{if(r.app.isQuitting,console.log("[Main Process] Evento before-quit (lógica de limpieza mejorada) recibido."),r.app.isQuitting=!0,E){console.log("[Main Process] Destruyendo icono de la bandeja del sistema desde before-quit.");try{E.destroy()}catch(s){console.error("[Main Process] Error destruyendo el tray:",s)}E=null}const o="SondaClickBackend.exe",n=()=>{console.log("[Main Process] Limpieza finalizada o tiempo de espera agotado. Saliendo de la aplicación..."),m&&(m=null),r.app.exit(0)},t=8e3,i=setTimeout(()=>{console.warn(`[Main Process] El tiempo de espera general de ${t}ms para la limpieza ha expirado.`),n()},t),a=()=>{console.log("[Main Process] Procediendo con taskkill para el backend."),process.platform==="win32"?L.exec(`taskkill /IM "${o}" /F /T`,s=>{clearTimeout(i),console.log(`[Main Process] Comando taskkill para ${o} ejecutado.`),n()}):(clearTimeout(i),n())};if(m){console.log(`[Main Process] Intentando cierre ordenado del backend en http://localhost:${$}/shutdown`);const s=new AbortController,l=s.signal,g=setTimeout(()=>s.abort(),2e3);fetch(`http://localhost:${$}/shutdown`,{method:"POST",signal:l}).then(h=>{clearTimeout(g),console.log(`[Main Process] Solicitud de cierre ordenado enviada. Respuesta: ${h.status}`),setTimeout(a,500)}).catch(h=>{clearTimeout(g),h.name,a()})}else console.log("[Main Process] No hay proceso backend registrado o ya se ha cerrado. Procediendo con la salida."),clearTimeout(i),n()}),r.app.on("window-all-closed",()=>{r.app.isQuitting?process.platform:console.log("[Main Process] Todas las ventanas cerradas, pero la app sigue en la bandeja.")}),r.app.on("activate",()=>{r.BrowserWindow.getAllWindows().length===0?r.app.isQuitting||(m?(M(),E?k():I()):(console.warn("[Main Process] activate event: Backend no está corriendo. Intentando reiniciar backend..."),O().then(()=>{M(),E?k():I()}).catch(e=>{const o=e instanceof Error?e.message:String(e);r.dialog.showErrorBox("Error de Reactivación",`No se pudo reiniciar el backend al activar la aplicación. Error: ${o}`)}))):(c==null||c.show(),c==null||c.focus(),v=!1,k())})):(console.log("[Main Process] Otra instancia ya está en ejecución. Saliendo de esta instancia."),r.app.quit());
